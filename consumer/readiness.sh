#!/bin/bash

# apt update -y
# apt install wget
# apt install default-jdk

# wget https://archive.apache.org/dist/kafka/3.0.0/kafka_2.13-3.0.0.tgz
# tar -xzf kafka_2.13-3.0.0.tgz
cd /opt/app

BROKER="kafka-broker-0-external.kafka-ns.svc.cluster.local"
PORT="9094"
TOPIC="push_cve_records"

# Check Kafka broker connection
if ! telnet $BROKER $PORT </dev/null 2>&1 | grep -q "Connected"; then
echo "Unable to connect to Kafka broker at $BROKER:$PORT"
exit 1
fi

# List the topics
TOPICS=$(bin/kafka-topics.sh --list --bootstrap-server $BROKER:$PORT)

# Check if the specified topic exists in the list
echo "$TOPICS" | grep -q "$TOPIC"
if [ $? -eq 0 ]; then
echo "Topic $TOPIC exists."
exit 0
else
echo "Topic $TOPIC does not exist."
exit 1
fi

apt-get update && apt-get install -y postgresql-client telnet
PSQL_HOST="{{ .Values.postgres.host }}"
PSQL_PORT="{{ .Values.postgres.port }}"
PSQL_USER="{{ .Values.postgres.user }}"
PSQL_DB="{{ .Values.postgres.dbname }}"
PSQL_PASSWORD="{{ .Values.postgres.password }}"


PGPASSWORD=$PSQL_PASSWORD psql -h $PSQL_HOST -U $PSQL_USER -d $PSQL_DB -c '\q'
if [ $? -ne 0 ]; then
echo "Unable to connect to PostgreSQL database at $PSQL_HOST:$PSQL_PORT"
exit 1
fi

echo "All checks passed successfully."
exit 0
